<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/tsavorite/locking" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Locking | Garnet</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/garnet/docs/dev/tsavorite/locking"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Locking | Garnet"><meta data-rh="true" name="description" content="There are three modes of locking in Tsavorite, set by a ConcurrencyControlMode value on the Tsavorite constructor:"><meta data-rh="true" property="og:description" content="There are three modes of locking in Tsavorite, set by a ConcurrencyControlMode value on the Tsavorite constructor:"><link data-rh="true" rel="icon" href="/garnet/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/garnet/docs/dev/tsavorite/locking"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/tsavorite/locking" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/garnet/docs/dev/tsavorite/locking" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/garnet/blog/rss.xml" title="Garnet RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/garnet/blog/atom.xml" title="Garnet Atom Feed">



<script>!function(t,e,n,c,a,r,s){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/loh6v65ww5",(s=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,s)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/garnet/assets/css/styles.935cd830.css">
<script src="/garnet/assets/js/runtime~main.f1917227.js" defer="defer"></script>
<script src="/garnet/assets/js/main.207d6539.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/garnet/"><div class="navbar__logo"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/garnet/img/garnet-logo-diamond.png" alt="Garnet Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Garnet</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/garnet/docs">Docs</a><a class="navbar__item navbar__link" href="/garnet/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/garnet/docs">Welcome</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/news">News</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/releases">Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/compatibility">Compatibility</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/faq">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/welcome/about-us">About Us</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/garnet/docs/getting-started">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/garnet/docs/benchmarking/overview">Benchmarking</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/garnet/docs/commands/overview">Commands</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/garnet/docs/extensions/transactions">Server Extensions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/garnet/docs/cluster/overview">Cluster Mode</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/garnet/docs/dev/onboarding">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/onboarding">Onboarding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/code-structure">Code Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/network">Network Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/processing">Processing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/garnet-api">Garnet API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/garnet/docs/dev/tsavorite/intro">Tsavorite - Storage Layer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/tsavorite/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/tsavorite/reviv">Revivification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/garnet/docs/dev/tsavorite/locking">Locking</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/transactions">Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/custom-commands">Custom Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/cluster">Cluster Mode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/garnet/docs/dev/contributing">Contributing</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="https://github.com/microsoft/garnet/releases" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Other Links</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/garnet/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tsavorite - Storage Layer</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Locking</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Locking</h1>
<p>There are three modes of locking in Tsavorite, set by a <code>ConcurrencyControlMode</code> value on the Tsavorite constructor:</p>
<ul>
<li><code>LockTable</code>: Tsavorite&#x27;s hash index buckets are used to hold the lock state. Locktable locking is either manual or transient:<!-- -->
<ul>
<li><strong>Manual</strong>: Garnet calls a <code>Lock</code> method on <code>LockableContext</code> or <code>LockableUnsafeContext</code> (hereafter referred to collectively as <code>Lockable*Context</code>) at the beginning of a transaction, passing an ordered array of keys, and must call <code>Unlock</code> when the transaction is complete. Tsavorite does not try to lock during individual operations on these session contexts.</li>
<li><strong>Transient</strong>: Tsavorite acquires and releases locks for individual keys as it performs individual operations.</li>
</ul>
</li>
<li><code>RecordIsolation</code>: This locks in-memory records as needed for the duration of a data operation: Upsert, RMW, Read, or Delete. Collectively, these are referred to here as <code>InternalXxx</code> for the internal methods that implement them.</li>
<li><code>None</code>: No locking is done by Tsavorite.</li>
</ul>
<p>All locks are obtained via spinning on <code>Interlocked.CompareExchange</code> and <code>Thread.Yield()</code> and have limited spin count, to avoid deadlocks; if they fail to acquire the desired lock in this time, the operation retries.</p>
<p>As noted above, manual locking is done by obtaining the <code>Lockable*Context</code> instance from a <code>ClientSession</code>. There are currently 4 <code>*Context</code> implementations; all are <code>struct</code> for inlining. All <code>*Context</code> are obtained as properties on the <code>ClientSession</code> named for the type (e.g. <code>clientSession.LockableContext</code>). The characteristics of each <code>*Context</code> are:</p>
<ul>
<li><strong><code>BasicContext</code></strong>: This is exactly the same as <code>ClientSession</code>, internally calling directly through to <code>ClientSession</code>&#x27;s methods and reusing <code>ClientSession</code>&#x27;s <code>TsavoriteSession</code>. It provides safe epoch management (acquiring and releasing the epoch on each call) and Transient locking.</li>
<li><strong><code>UnsafeContext : IUnsafeContext</code></strong>: This provides Transient locking, but rather than safe epoch management handled per-operation by Tsavorite, this supports &quot;unsafe&quot; manual epoch management controlled by the client via <code>BeginUnsafe()</code> and <code>EndUnsafe()</code>; it is the client&#x27;s responsibility to make these calls correctly. <code>UnsafeContext</code> API methods call the internal ContextRead etc. methods without doing the Resume and Suspend (within try/finally) of epoch protection as is done by the &quot;Safe&quot; API methods.</li>
<li><strong><code>LockableContext : ILockableContext</code></strong>: This provides safe epoch management, but rather than Transient locking, this requires Manual locks via <code>BeginLockable</code> and <code>EndLockable</code>. This requirement ensures that all locks are acquired before any methods accessing those keys are called.</li>
<li><strong><code>LockableUnsafeContext : ILockableContext, IUnsafeContext</code></strong>: This combines manual epoch management and manual locking, exposing both sets of methods.</li>
</ul>
<p>In addition to the <code>Lock</code> methods, Tsavorite supports:</p>
<ul>
<li><code>TryLock</code>: Accepts an array of keys and returns true if all locks were acquired, else false (and any locks that were acquired are released)</li>
<li><code>TryPromoteLock</code>: Accepts a single key and returns true if the key&#x27;s lock could be promoted from Read to Exclusive.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="considerations">Considerations<a href="#considerations" class="hash-link" aria-label="Direct link to Considerations" title="Direct link to Considerations">​</a></h2>
<p>All manual locking of keys must lock the keys in a deterministic order, and unlock in the reverse order, to avoid deadlocks.</p>
<p>Lock spinning is limited in order to avoid deadlocks such as the following:</p>
<ul>
<li><code>Lockable*Context</code> LC1 exclusively locks k1</li>
<li><code>BasicContext</code> BC1 tries to acquire an exclusive Transient lock on k1, and spins while holding the epoch</li>
<li>LC1 does an RMW on k1 resulting in a CopyUpdate; this does a BlockAllocate that finds it must flush pages from the head of the log in order to make room at the tail.<!-- -->
<ul>
<li>LC1 therefore calls BumpCurrentEpoch(... OnPagesClosed)</li>
<li>Because BC1 holds the epoch, the OnPagesClosed() call is never drained, so we have deadlock
By ensuring that locks are limited in spins, we force one or both of the above sessions to release any locks it has already aquired and return up the callstack to retry the operation via RETRY_LATER (which refreshes the epoch, allowing other operations such as the OnPagesClosed() mentioned above to complete).</li>
</ul>
</li>
</ul>
<p><code>RecordIsolation</code> and Transient locks are never held across pending I/O or other Wait operations. All the data operations&#x27; low-level implementors (<code>InternalRead</code>, <code>InternalUpsert</code>, <code>InternalRMW</code>, and <code>InternalDelete</code>--collectively known as <code>InternalXxx</code>) release these locks when the call is exited; if the operations must be retried, the locks are reacquired as part of the normal operation there.</p>
<p><code>RecordIsolation</code> locks, including those in the ReadCache, operate under epoch protection, so locked records will not be evicted until they are unlocked and the context has released the epoch.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h2>
<p>Here is an example of the above two use cases, condensed from the unit tests in <code>LockableUnsafeContextTests.cs</code>:</p>
<div class="language-cs codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cs codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    var luContext = session.GetLockableUnsafeContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.BeginUnsafe();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.BeginLockable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var keys = new[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new FixedLengthLockableKeyStruct&lt;long&gt;(readKey24, LockType.Shared, luContext),      // Source, shared</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new FixedLengthLockableKeyStruct&lt;long&gt;(readKey51, LockType.Shared, luContext),      // Source, shared</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new FixedLengthLockableKeyStruct&lt;long&gt;(resultKey, LockType.Exclusive, luContext),   // Destination, exclusive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Sort the keys to guard against deadlock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.SortKeyHashes(keys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.IsTrue(luContext.TryLock(keys));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.Read(key24, out var value24);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.Read(key51, out var value51);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.Upsert(resultKey, value24 + value51);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.Unlock(keys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.EndLockable();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    luContext.EndUnsafe();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="internal-design">Internal Design<a href="#internal-design" class="hash-link" aria-label="Direct link to Internal Design" title="Direct link to Internal Design">​</a></h2>
<p>This section covers the internal design and implementation of Tsavorite&#x27;s locking.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="operation-data-structures">Operation Data Structures<a href="#operation-data-structures" class="hash-link" aria-label="Direct link to Operation Data Structures" title="Direct link to Operation Data Structures">​</a></h3>
<p>There are a number of variables necessary to track the main hash table entry information, the &#x27;source&#x27; record as defined above (including <code>RecordIsolation</code> locks if applicable), and other stack-based data relevant to the operation. These variables are placed within structs that live on the stack at the <code>InternalXxx</code> level.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hashentryinfo">HashEntryInfo<a href="#hashentryinfo" class="hash-link" aria-label="Direct link to HashEntryInfo" title="Direct link to HashEntryInfo">​</a></h4>
<p>This is used for hash-chain traversal and CAS updates. It consists primarily of:</p>
<ul>
<li>The key&#x27;s hash code and associated tag.</li>
<li>a stable copy of the <code>HashBucketEntry</code> at the time the <code>HashEntryInfo</code> was populated.<!-- -->
<ul>
<li>This has both <code>Address</code> (which may or may not include the readcache bit) and <code>AbsoluteAddress</code> (<code>Address</code> stripped of the readcache bit) accessors.</li>
</ul>
</li>
<li>a pointer (in the unsafe &quot;C/C++ *&quot; sense) to the live <code>HashBucketEntry</code> that may be updated by other sessions as our current operation proceeds.<!-- -->
<ul>
<li>As with the stable copy, this has two address accessors: <code>CurrentAddress</code> (which may or may not include the readcache bit) and <code>AbsoluteCurrentAddress</code> (<code>CurrentAddress</code> stripped of the readcache bit).</li>
</ul>
</li>
<li>A method to update the stable copy of the <code>HashBucketEntry</code> with the current information from the &#x27;live&#x27; pointer.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="recordsource">RecordSource<a href="#recordsource" class="hash-link" aria-label="Direct link to RecordSource" title="Direct link to RecordSource">​</a></h4>
<p>This is implemented as <code>RecordSource&lt;TKey, TValue&gt;</code> and carries the information identifying the source record and lock information for that record:</p>
<ul>
<li>Whether there is an in-memory source record, and if so:<!-- -->
<ul>
<li>its logical and physical addresses</li>
<li>whether it is in the readcache or main log</li>
<li>whether it is locked</li>
</ul>
</li>
<li>The latest logical address of this key hash in the main log. If there are no readcache records, then this is the same as the <code>HashEntryInfo</code> Address;</li>
<li>If there are readcache records in the chain, then <code>RecordSource</code> contains the lowest readcache logical and physical addresses. These are used for &#x27;splicing&#x27; a new main-log record into the gap between the readcache records and the main log recoreds; see <a href="#readcache">ReadCache</a> below.</li>
<li>The log (readcache or hlog) in which the source record, if any, resides. This is hlog unless there is a source readcache record.</li>
<li>Whether a LockTable lock was acquired. This is exclusive with in-memory locks; only one should be set.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="operationstackcontext">OperationStackContext<a href="#operationstackcontext" class="hash-link" aria-label="Direct link to OperationStackContext" title="Direct link to OperationStackContext">​</a></h4>
<p>This contains all information on the stack that is necessary for the operation, making parameter lists much smaller. It contains:</p>
<ul>
<li>The <code>HashEntryInfo</code>  and <code>RecordSource&lt;TKey, TValue&gt;</code> for this operation. These are generally used together, and in some situations, such as when hlog.HeadAddress has changed due to an epoch refresh, <code>RecordSource&lt;TKey, TValue&gt;</code> is reinitialized from <code>HashEntryInfo</code> during the operation.</li>
<li>the logical address of a new record created for the operation. This is passed back up the chain so the try/finally can set it invalid and non-tentative on exceptions, without having to pay the cost of a nested try/finally in the <code>CreateNewRecord*</code> method.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lock-locations">Lock Locations<a href="#lock-locations" class="hash-link" aria-label="Direct link to Lock Locations" title="Direct link to Lock Locations">​</a></h3>
<p>This section discusses where locks are actually stored.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="locktable">LockTable<a href="#locktable" class="hash-link" aria-label="Direct link to LockTable" title="Direct link to LockTable">​</a></h4>
<p>For HashTable locking, the key is hashed to its code which is modulo&#x27;d to find the hash table bucket index. This bucket consists of a vector of 8 <code>HashBucketEntries</code> (cache-aligned, as each HashBucketEntry contains only a &#x27;long&#x27;). The entries are organized by &#x27;tags&#x27;, which are the upper 14 bits of the hashcode. The 8th <code>HashBucketEntry</code> is used as a linked list to an overflow bucket; its Address property is a separate allocation that points to an overflow bucket. Thus, a bucket contains 7 entries and a pointer to another bucket if more than 7 tags have been found.</p>
<p>Following is a simplified overfire of the &#x27;tag&#x27; logic, using <code>FindOrCreateTag</code> as an example:</p>
<ul>
<li>Iterate the first 7 entries of all buckets, including overflow. If the tag is found, use that entry.</li>
<li>Otherwise, if an empty entry was found, assign this tag to the first empty entry and use that entry.</li>
<li>otherwise, add an overflow bucket and repeat the first two steps in that bucket.
(<code>FindTag</code> is simpler, since it does not have to add an entry; it returns false if the tag is not found).</li>
</ul>
<p>For the first bucket, the tag bits of its overflow entry are used for locking; see the <code>HashBucket</code> class for detailed comments. There are 16 tag bits; for locking, 15 bits are used for shared (Read) locking and one bit for exclusive locking.</p>
<p>Thus, a key is locked indirectly, by having its <code>HashBucket</code> locked. This may result in multiple keys being locked (all keys that hash to that bucket) rather than just the required key.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="recordinfo">RecordInfo<a href="#recordinfo" class="hash-link" aria-label="Direct link to RecordInfo" title="Direct link to RecordInfo">​</a></h4>
<p>For RecordIsolation locking, the RecordInfo header is used. It has one Exclusive Lock bit and 6 Shared Lock bits, allowing 64 shared locks. Because locking does not affect data, even <code>RecordInfo</code>s in the ReadOnly region may be locked and unlocked directly. Additionally, records in the ReadCache may be locked, as they are encountered first by other threads searching for the key.</p>
<p>Other relevant <code>RecordInfo</code> bits:</p>
<ul>
<li><strong>Sealed</strong>: A record marked Sealed has been superseded by an update (and the record may be in the Revivification FreeList). Sealing is necessary because otherwise one thread could do an RCU (Read, Copy, Update) with a value too large to be an IPU (In-Place Update), while at the same time another thread could do an IPU with a value small enough to fit. A thread encountering a Sealed record should immediately return RETRY_LATER (it must be RETRY_LATER instead of RETRY_NOW, because the thread owning the Seal must do another operation, such as an Insert to tail, to bring things into a consistent state; this operation may require epoch refresh).<!-- -->
<ul>
<li>Sealing is done via <code>RecordInfo.Seal</code>. This is only done when the <code>LockTable</code> entry or <code>RecordInfo</code> is already exclusively locked, so <code>Seal()</code> does a simple bitwise operation. RecordIsolation <code>Lock</code> checks the <code>Sealed</code> bit and fails if it is found; a Sealed record should never be operated on.</li>
</ul>
</li>
<li><strong>Invalid</strong>: This indicates that the record is to be skipped, using its <code>.PreviousAddress</code> to move along the chain, rather than restarted. This &quot;skipping&quot; semantic is primarily relevant to the readcache; we should not have invalid records in the main log&#x27;s hash chain. Indeed, any main-log record that is not in the hash chain <em>must</em> be marked Invalid.<!-- -->
<ul>
<li>In the <code>ReadCache</code> we do not Seal records; the semantics of Seal are that the operation is restarted when a Sealed record is found. For non-<code>readcache</code> records, this causes the execution to restart at the tail of the main-log records. However, <code>readcache</code> records are at the beginning of the hash chain, <em>before</em> the main-log records; thus, restarting would start again at the hash bucket, traverse the readcache records, and hit the Sealed record again, ad infinitum.</li>
<li>Thus, we instead set <code>readcache</code> records to Invalid when they are no longer current; this allows the traversal to continue until the readcache chain links to the first main-log record.</li>
</ul>
<!-- -->Additionally, records may be elided (removed) from the tag chain for one of the following reasons:<!-- -->
<ul>
<li>The record was deleted</li>
<li>The record was a &quot;source&quot; for RCU</li>
</ul>
<!-- -->In these cases, if the record&#x27;s <code>PreviousAddress</code> points below <code>hlog.BeginAddress</code>, we remove the record so we do not have to waste an IO to determine that it is a superseded record.<!-- -->
<ul>
<li>Such elided records are put into the FreeList if it is enabled for Revivification.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="locking-flow">Locking Flow<a href="#locking-flow" class="hash-link" aria-label="Direct link to Locking Flow" title="Direct link to Locking Flow">​</a></h3>
<p>When <code>Internalxxx</code> executes it locks in the following way, depending on the <code>TsavoriteKV</code>&#x27;s <code>ConcurrencyControlMode</code>:</p>
<ul>
<li><code>LockTable</code>: We obtain the key hash at the start of the operation, so we lock its bucket if we are not in a <code>Lockable*Context</code> (if we are, we later Assert that the key is already locked).</li>
<li><code>RecordIsolation</code>: once we have populated the <code>HashEntryInfo</code> with the logicalAddress of the key&#x27;s record and determined it is in-memory, we lock its <code>RecordInfo</code>.<!-- -->
<ul>
<li>If the record is <code>Closed</code>, which means <code>Sealed</code> or <code>Invalid</code>, the lock attempt fails immediately upon detecting this.</li>
<li>Due to FreeList Revivification, the record may have been elided from the tag chain while we were locking it; we check for this and update the <code>HashEntryInfo</code> to be the current <code>HashBucketEntry</code>.</li>
</ul>
</li>
</ul>
<p>Following this, the requested operation is performed within a try/finally block whose &#x27;finally&#x27; unlocks as appropriate for the <code>ConcurrencyControlMode</code>.</p>
<p>For RCU-like operations such as RMW or Upsert of an in-memory (including in-ReadCache) record, <code>RecordIsolation</code> mode seals the source record (and may invalidate it to allow it to be freelisted for Revivification) as part of releasing its exclusive lock, to ensure atomicity.</p>
<p>Similar locking logic applies to the pending IO completion routines: <code>ContinuePendingRead</code>, <code>ContinuePendingRMW</code>, and <code>ContinuePendingConditionalCopyToTail</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="readcache">ReadCache<a href="#readcache" class="hash-link" aria-label="Direct link to ReadCache" title="Direct link to ReadCache">​</a></h3>
<p>The readcache is a cache for records that are read from disk. In the case of record that become &#x27;hot&#x27; (read multiple times) this saves multiple IOs. It is of fixed size determined at TsavoriteKV startup, and has no on-disk component; records in the ReadCache are evicted from the head without writing to disk when enough new records are added to the tail to exceed the memory-size specification.</p>
<p>When the <code>ReadCache</code> is enabled, records from the <code>ReadCache</code> are inserted into the tag chain starting at the <code>HashBucketEntry</code> (these records are identified as <code>ReadCache</code> by a combination of <code>TsavoriteKV.UseReadCache</code> being set <em>and</em> the ReadCache bit in the <code>RecordInfo</code> is set). All <code>ReadCache</code> records come before any main log record. So (using r#### to indicate a <code>ReadCache</code> record and m#### to indicate a main log record):</p>
<ul>
<li>When there are no <code>ReadCache</code> entries in a hash chain, it looks like: <code>HashTable</code> -&gt; m4000 -&gt; m3000 -&gt; m...</li>
<li>When there are <code>ReadCache</code> entries in a hash chain, it looks like: <code>HashTable</code> -&gt; r8000 -&gt; r7000 -&gt; m4000 -&gt; m3000 -&gt; m...</li>
</ul>
<p>As a terminology note, the sub-chain of r#### records is referred to as the <code>ReadCache</code> prefix chain of that hash chain.</p>
<p>ReadCache records are locked only in <code>RecordIsolation</code> mode. <code>LockTable</code> locking handles both main log and readcache cases.</p>
<p>Records in the readcache participate in <code>RecordIsolation</code> locking, either because they are the record to be read, or because they are the &#x27;source&#x27; of an update. If the key is found in the readcache, then the <code>RecordSource&lt;TKey, TValue&gt;.Log</code> is set to the readcache, and the logicalAddress is set to the readcache record&#x27;s logicalAddress (which has the ReadCache bit). If the operation is a successful update (which will always be an RCU; readcache records are never themselves updated), the following steps happen:</p>
<ul>
<li>The new version of the record is &quot;spliced in&quot; to the tag chain after the readcache prefix</li>
<li>The readcache &quot;source&quot; record is invalidated.</li>
</ul>
<p>Using the above example and assuming an update of r8000, the resulting chain would be:</p>
<ul>
<li><code>HashTable</code> -&gt; r8000 (invalid) -&gt; r7000 -&gt; mxxxx (new) -&gt; m4000 -&gt; m3000 -&gt; m...</li>
<li>In this example, note that the record address spaces are totally different between the main log and readcache; &quot;xxxx&quot; is used as the &quot;new address&quot; to symbolize this.</li>
</ul>
<p>This splicing operation requires that we deal with updates at the tail of the tag chain (in the <code>HashEntryInfo</code>) as well as at the splice point. This cannot be done as a single atomic operation. To handle this, we detach the readcache prefix chain, insert the new record at the tail, and then reattach the detached records. See <code>DetachAndReattachReadCacheChain</code> for specifics. We may fail the reattach, but this is acceptable (versus more complicated and expensive locking) because such failures should be rare and the readcache is just a performance optimization.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/microsoft/garnet/tree/main/website/docs/dev/tsavorite/locking.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/garnet/docs/dev/tsavorite/reviv"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Revivification</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/garnet/docs/dev/transactions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Transactions</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#considerations" class="table-of-contents__link toc-highlight">Considerations</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#internal-design" class="table-of-contents__link toc-highlight">Internal Design</a><ul><li><a href="#operation-data-structures" class="table-of-contents__link toc-highlight">Operation Data Structures</a></li><li><a href="#lock-locations" class="table-of-contents__link toc-highlight">Lock Locations</a></li><li><a href="#locking-flow" class="table-of-contents__link toc-highlight">Locking Flow</a></li><li><a href="#readcache" class="table-of-contents__link toc-highlight">ReadCache</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/docs/getting-started">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://aka.ms/garnet-discord" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/msrgarnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/garnet/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/microsoft/garnet" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p class="text-center">
          <a href="https://go.microsoft.com/fwlink/?LinkId=521839" style="color: white;">Privacy &amp; Cookies</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=2259814" style="color: white;">Consumer Health Privacy</a> |
          <a href="https://go.microsoft.com/fwlink/?LinkID=206977" style="color: white;">Terms of Use</a> |
          <a href="https://www.microsoft.com/trademarks" style="color: white;">Trademarks</a> | © 2024
          </p></div></div></div></footer></div>
</body>
</html>